<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NGP Hub — Audio Remix (Beta)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0e0e11; --card:#15151b; --ink:#ececf1; --muted:#b5b7c3;
    --brandA:#6a11cb; --brandB:#2575fc; --line:#3a66ff;
    --ring:0 0 0 .2rem rgba(37,117,252,.35);
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b0b0e,#121219 60%,#0d0d14);
    color:var(--ink);
    font-family:'Rubik',system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    scroll-behavior:smooth;
  }
  .wrap{max-width:1024px; margin:0 auto; padding:0 16px}

  /* Header */
  header{
    position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(10px);
    background:rgba(10,10,14,.6); border-bottom:1px solid rgba(255,255,255,.06);
  }
  .bar{display:flex; align-items:center; justify-content:space-between; padding:12px 0}
  .logo{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink)}
  .logo-mark{width:28px; height:28px; border-radius:10px; background:linear-gradient(135deg,var(--brandA),var(--brandB)); box-shadow:var(--shadow)}
  .logo h1{font-size:1.05rem; margin:0; letter-spacing:.3px}
  nav{display:flex; align-items:center; gap:6px; flex-wrap:wrap}
  nav a{
    color:var(--ink); text-decoration:none; font-weight:500; margin-left:0;
    padding:8px 10px; border-radius:10px; opacity:.9
  }
  nav a:hover, nav a:focus-visible{background:rgba(255,255,255,.06); outline:none; box-shadow:var(--ring)}

  /* Footer */
  footer{border-top:1px solid rgba(255,255,255,.08); color:var(--muted); padding:24px 0 36px; text-align:center}

  /* Page */
  main{padding:28px 0 40px}
  .grid{display:grid; grid-template-columns:320px 1fr; gap:24px}
  .panel{
    position:relative;
    background:var(--card); border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius); box-shadow:var(--shadow);
    overflow:hidden;
  }
  .panel h2{margin:0; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); font-size:1rem}
  .list{max-height:420px; overflow:auto}
  .fileRow{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.05); cursor:default;
  }
  .fileRow:hover{background:rgba(255,255,255,.04)}
  .fileTitle{font-weight:600}
  .fileMeta{color:var(--muted); font-size:.85rem}
  .dots{opacity:.6}
  .controls{padding:16px; padding-right:70px;} /* leave room for gain dock */
  .knob{margin:14px 0}
  .knob label{display:flex; align-items:center; justify-content:space-between; font-weight:600; margin-bottom:8px}
  .knob small{color:var(--muted); margin-left:8px; font-weight:400}
  input[type="range"]{width:100%}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
    box-shadow:var(--shadow)
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btnGhost{
    background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.2);
    border-radius:12px; padding:9px 12px; font-weight:600; cursor:pointer;
  }
  .pill{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px}
  .wave{height:140px; background:repeating-linear-gradient(90deg,rgba(255,255,255,.06) 0 1px, transparent 1px 4px), radial-gradient(ellipse at center, rgba(106,17,203,.2), transparent 60%);}
  .timeline{display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); padding:6px 10px 0}
  .playerBar{
    position:sticky; bottom:0; left:0; right:0;
    background:rgba(10,10,14,.8); backdrop-filter:saturate(140%) blur(10px);
    border-top:1px solid rgba(255,255,255,.08);
  }
  .playerInner{max-width:1024px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:10px}
  .play{width:42px; height:42px; border-radius:999px; display:grid; place-items:center; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.06); cursor:pointer}
  .time{min-width:64px; text-align:center; font-variant-numeric:tabular-nums}
  .grow{flex:1}
  .muted{color:var(--muted)}
  .tip{font-size:.85rem; color:var(--muted)}
  .tag{font-size:.75rem; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:#cbd5ff}
  .switch{display:inline-flex; align-items:center; gap:8px}
  .switch input{transform:scale(1.2)}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  @media (prefers-reduced-motion: reduce){*{transition:none !important; animation:none !重要}}

  /* Gain dock (right side vertical slider) */
  .gainDock{
    position:absolute; top:58px; right:10px; bottom:10px;
    width:44px; display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .gainDock .cap{font-size:.7rem; color:var(--muted)}
  .gainDock input[type="range"]{
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical;
    appearance: slider-vertical;
    width: 44px; height: 260px;
  }
  .gainBadge{
    font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.06);
  }
</style>
</head>
<body>

<header>
  <div class="wrap bar">
    <a class="logo" href="/"><span class="logo-mark" aria-hidden="true"></span><h1>NGP</h1></a>
    <nav aria-label="Primary">
      <a href="/tools">Tools</a>
      <a href="/discordservers/">Servers</a>
      <a href="/projects">Projects</a>
      <a href="/docs/">Docs</a>
      <a href="/roblox">Roblox</a>
      <a href="/contact">Contact</a>
    </nav>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="row" style="margin-bottom:12px; justify-content:space-between;">
      <div class="row">
        <button id="addBtn" class="btnGhost">+ Add file</button>
        <button id="clearBtn" class="btnGhost">✕ Clear</button>
        <div class="pill" id="dlMenu"><span>Download</span></div>
      </div>
      <span class="tag">No need to pay, straight from the browser!</span>
    </div>

    <div class="grid">
      <!-- Left: file list -->
      <section class="panel" aria-label="Files">
        <h2>Files</h2>
        <div class="list" id="fileList">
          <div class="fileRow muted">No file yet. Click “Add file”.</div>
        </div>
      </section>

      <!-- Right: editor -->
      <section class="panel" aria-label="Editor">
        <h2 id="currentName">—</h2>
        <div class="wave" id="wave"></div>
        <div class="timeline"><span id="tStart">0:00</span><span id="tEnd">0:00</span></div>

        <div class="controls">
          <div class="row" style="justify-content:flex-start; gap:12px;">
            <span class="pill">Presets</span>
            <button class="btnGhost" data-preset="slowed">Slowed+Reverb</button>
            <button class="btnGhost" data-preset="nightcore">Nightcore</button>
          </div>

          <div class="knob">
            <label>Speed <small id="speedLbl">(1.0×)</small></label>
            <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1.0" />
            <div class="row tip switch" style="margin-top:6px;">
              <input type="checkbox" id="preserve" />
              <label for="preserve" class="muted">Smooth time-stretch (keeps pitch, used for download; preview uses simple speed)</label>
            </div>
          </div>

          <div class="knob">
            <label>Reverb <small id="reverbLbl">(0%)</small></label>
            <input type="range" id="reverb" min="0" max="100" step="1" value="0" />
          </div>

          <div class="knob">
            <label>Bass boost <small id="bassLbl">(0 dB)</small></label>
            <input type="range" id="bass" min="0" max="18" step="1" value="0" />
          </div>

          <div class="row" style="margin-top:10px">
            <button id="downloadBtn" class="btn" disabled>Download</button>
            <button id="trimBtn" class="btnGhost" disabled>Export selection (soon)</button>
            <span class="tip">Tip: Download uses a smooth grain stretcher to avoid stutter.</span>
          </div>
        </div>

        <!-- Audio Gain dock (right side) -->
        <aside class="gainDock" aria-label="Output Gain">
          <span class="cap">+24</span>
          <input type="range" id="gainSlider" min="-24" max="24" step="1" value="0" aria-label="Gain (dB)" />
          <span class="cap">-24</span>
          <span class="gainBadge" id="gainLbl">Gain 0 dB</span>
        </aside>
      </section>
    </div>
  </div>
</main>

<!-- Player bar -->
<div class="playerBar">
  <div class="playerInner">
    <button class="play" id="playBtn" aria-label="Play/Pause">▶</button>
    <div class="time" id="curTime">0:00</div>
    <input class="grow" type="range" id="seek" min="0" max="1" step="0.0001" value="0" />
    <div class="time" id="durTime">0:00</div>
    <span class="muted" id="status">Ready</span>
  </div>
</div>

<footer>
  <div class="wrap">
    <small>© <span id="year"></span> NGP — Alpha.</small>
  </div>
</footer>

<input type="file" id="fileInput" accept="audio/*" hidden />

<script>
  // UI els
  const $ = id => document.getElementById(id);
  $('year').textContent = new Date().getFullYear();
  const addBtn = $('addBtn'), clearBtn = $('clearBtn'), fileInput = $('fileInput');
  const fileList = $('fileList'), playBtn = $('playBtn'), seek = $('seek');
  const curTime = $('curTime'), durTime = $('durTime'), tStart = $('tStart'), tEnd = $('tEnd');
  const wave = $('wave'), statusEl = $('status'), downloadBtn = $('downloadBtn');
  const speed = $('speed'), reverb = $('reverb'), bass = $('bass');
  const speedLbl = $('speedLbl'), reverbLbl = $('reverbLbl'), bassLbl = $('bassLbl');
  const preserve = $('preserve'), currentName = $('currentName');
  const gainSlider = $('gainSlider'), gainLbl = $('gainLbl');

  // Audio graph
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let src = null, buf = null;

  // nodes
  let convolver = ctx.createConvolver();
  let lowShelf = ctx.createBiquadFilter(); lowShelf.type = "lowshelf"; lowShelf.frequency.value = 140;
  let outGain = ctx.createGain(); // master/output gain

  // chain: source -> convolver -> lowshelf -> outGain -> destination
  convolver.buffer = makeImpulse(0.0001); // almost dry to start
  outGain.connect(ctx.destination);
  convolver.connect(lowShelf); lowShelf.connect(outGain);

  function connectSource() {
    if (!buf) return;
    if (src) { try{src.stop();}catch{} src.disconnect(); }
    src = ctx.createBufferSource();
    src.buffer = buf;
    src.playbackRate.value = parseFloat(speed.value);
    src.connect(convolver);
    src.onended = () => { playing = false; playBtn.textContent = '▶'; };
  }

  // State
  let fileMeta = null, playing = false, startAt = 0, started = 0;

  // Helpers
  const fmt = s => {
    s = Math.max(0, s|0); const m = (s/60)|0, r = s%60; return `${m}:${r.toString().padStart(2,'0')}`;
  };
  const dbToLinear = db => Math.pow(10, db/20);

  function setStatus(t){ statusEl.textContent = t; }

  // Waveform canvas
  const cvs = document.createElement('canvas'); cvs.width = wave.clientWidth; cvs.height = wave.clientHeight; wave.appendChild(cvs);
  const c2 = cvs.getContext('2d');

  function drawWave(abuf){
    c2.clearRect(0,0,cvs.width,cvs.height);
    if(!abuf){ return; }
    const ch = abuf.getChannelData(0);
    const step = Math.max(1, Math.floor(ch.length / cvs.width));
    const mid = cvs.height/2;
    c2.fillStyle = 'rgba(255,255,255,.9)';
    for(let x=0;x<cvs.width;x++){
      let min=1, max=-1;
      const i0 = x*step;
      for(let i=i0;i<i0+step && i<ch.length;i++){ const v = ch[i]; if(v<min)min=v; if(v>max)max=v; }
      c2.fillRect(x, mid + min*mid, 1, Math.max(1,(max-min)*mid));
    }
  }

  // Reverb impulse (runtime)
  function makeImpulse(seconds=1.5, decay=2.5, reverse=false){
    const rate = ctx.sampleRate, length = Math.max(1,(seconds*rate)|0);
    const ir = ctx.createBuffer(2, length, rate);
    for(let ch=0; ch<2; ch++){
      const data = ir.getChannelData(ch);
      for(let i=0;i<length;i++){
        const n = reverse ? length-i : i;
        data[i] = (Math.random()*2-1) * Math.pow(1 - n/length, decay);
      }
    }
    return ir;
  }

  // UI wiring
  addBtn.onclick = ()=> fileInput.click();
  fileInput.onchange = async e=>{
    const f = e.target.files[0];
    if(!f) return;
    const arr = await f.arrayBuffer();
    setStatus('Decoding…');
    buf = await ctx.decodeAudioData(arr);
    connectSource();
    fileMeta = {name: f.name};
    currentName.textContent = f.name;
    drawWave(buf);
    tStart.textContent = '0:00';
    tEnd.textContent = fmt(buf.duration|0);
    durTime.textContent = fmt(buf.duration|0);
    seek.value = 0; seek.max = buf.duration;
    makeListRow();
    downloadBtn.disabled = false;
    setStatus('Ready');
  };

  function makeListRow(){
    fileList.innerHTML = '';
    const row = document.createElement('div'); row.className='fileRow';
    row.innerHTML = `<div><div class="fileTitle">${fileMeta.name}</div>
      <div class="fileMeta">${speed.value}× speed, ${reverb.value}% reverb, ${bass.value} dB bass</div></div>
      <div class="dots">⋯</div>`;
    fileList.appendChild(row);
  }

  clearBtn.onclick = ()=>{
    if(src){ try{src.stop();}catch{} }
    src = null; buf=null; fileList.innerHTML='<div class="fileRow muted">No file yet. Click “Add file”.</div>';
    currentName.textContent='—'; c2.clearRect(0,0,cvs.width,cvs.height);
    seek.value=0; durTime.textContent='0:00'; tEnd.textContent='0:00'; downloadBtn.disabled=true; setStatus('Cleared');
  };

  // Play/Pause
  function nowPlaybackTime(){
    if(!src || !playing) return 0;
    return Math.min(buf.duration, startAt + (ctx.currentTime - started) * src.playbackRate.value);
  }

  playBtn.onclick = ()=>{
    if(!buf) return;
    if(!playing){
      connectSource();
      src.start(0, seek.value);
      startAt = seek.value; started = ctx.currentTime; playing = true;
      playBtn.textContent = '⏸';
    }else{
      try{ src.stop(); }catch{}
      seek.value = nowPlaybackTime();
      playing = false; playBtn.textContent = '▶';
    }
  };

  // Live controls
  speed.oninput = ()=>{
    speedLbl.textContent = `(${parseFloat(speed.value).toFixed(2)}×)`;
    if(src) src.playbackRate.value = parseFloat(speed.value);
    makeListRow();
  };
  reverb.oninput = ()=>{
    reverbLbl.textContent = `(${reverb.value}%)`;
    const amt = Math.max(0.0001, parseInt(reverb.value)/100);
    convolver.buffer = makeImpulse(1.8*amt+0.05, 3*amt+0.5, false);
    makeListRow();
  };
  bass.oninput = ()=>{
    bassLbl.textContent = `(${bass.value} dB)`;
    lowShelf.gain.value = parseFloat(bass.value);
    makeListRow();
  };

  // Output Gain (right dock)
  function setGain(db){
    outGain.gain.value = dbToLinear(db);
    gainLbl.textContent = `Gain ${db>0?'+':''}${db} dB`;
  }
  gainSlider.oninput = ()=> setGain(parseInt(gainSlider.value));
  setGain(0);

  // Seek
  seek.oninput = ()=>{
    if(!buf) return;
    if(playing){ try{src.stop();}catch{} playing=false; playBtn.textContent='▶'; }
    connectSource();
  };

  // UI loop
  function tick(){
    requestAnimationFrame(tick);
    if(!buf) return;
    const t = playing ? nowPlaybackTime() : parseFloat(seek.value);
    seek.value = t;
    curTime.textContent = fmt(t|0);
  }
  tick();

  // Presets
  document.querySelectorAll('[data-preset]').forEach(btn=>{
    btn.onclick = ()=>{
      const p = btn.dataset.preset;
      if(p==='slowed'){ speed.value=0.7; reverb.value=45; bass.value=0; }
      if(p==='nightcore'){ speed.value=1.25; reverb.value=0; bass.value=0; }
      speed.oninput(); reverb.oninput(); bass.oninput();
    };
  });

  // ======= Download (smooth stretch / keeps pitch) =======
  async function renderProcessed(buffer, speedX, reverbPct, bassDb){
    const rate = buffer.sampleRate;
    const channels = buffer.numberOfChannels;
    const outLen = Math.max(1, Math.floor(buffer.length / speedX));
    const grainSize = Math.floor(0.06 * rate);
    const hopIn = Math.floor(grainSize * 0.5);
    const hopOut = Math.floor(hopIn / speedX);
    const out = new Float32Array(outLen);
    const win = hann(grainSize);
    const mono = buffer.getChannelData(0);

    let inPos = 0, outPos = 0;
    while (inPos + grainSize < mono.length && outPos + grainSize < out.length){
      for(let i=0;i<grainSize;i++){
        const s = mono[inPos + i] * win[i];
        out[outPos + i] += s;
      }
      inPos += hopIn;
      outPos += hopOut;
    }

    const off = new OfflineAudioContext(channels, out.length, rate);
    const buf2 = off.createBuffer(channels, out.length, rate);
    for(let ch=0; ch<channels; ch++){
      if(ch===0){ buf2.getChannelData(0).set(out); }
      else{
        const srcCh = buffer.getChannelData(Math.min(ch, buffer.numberOfChannels-1));
        const chArr = buf2.getChannelData(ch);
        for(let i=0;i<out.length;i++){
          const srcIdx = Math.min(srcCh.length-1, Math.floor(i*speedX));
          chArr[i] = (srcCh[srcIdx] + out[i]) * 0.5;
        }
      }
    }

    const srcNode = off.createBufferSource(); srcNode.buffer = buf2;
    const conv = off.createConvolver(); conv.buffer = makeIR(off, Math.max(0.0001, reverbPct/100));
    const shelf = off.createBiquadFilter(); shelf.type='lowshelf'; shelf.frequency.value=140; shelf.gain.value = bassDb;

    const master = off.createGain(); master.gain.value = outGain.gain.value; // use current UI gain
    srcNode.connect(conv); conv.connect(shelf); shelf.connect(master); master.connect(off.destination);
    srcNode.start();
    const rendered = await off.startRendering();
    return rendered;
  }

  function hann(n){
    const w = new Float32Array(n);
    for(let i=0;i<n;i++){ w[i] = 0.5*(1 - Math.cos(2*Math.PI*i/(n-1))); }
    return w;
  }
  function makeIR(offCtx, amt){
    const seconds = 1.8*amt+0.05, decay = 3*amt+0.5;
    const rate = offCtx.sampleRate, length = Math.max(1,(seconds*rate)|0);
    const ir = offCtx.createBuffer(2, length, rate);
    for(let ch=0; ch<2; ch++){
      const data = ir.getChannelData(ch);
      for(let i=0;i<length;i++){
        data[i] = (Math.random()*2-1) * Math.pow(1 - i/length, decay);
      }
    }
    return ir;
  }

  // WAV encoder
  function toWav(audBuf){
    const numCh = audBuf.numberOfChannels, sr = audBuf.sampleRate, len = audBuf.length;
    const interleaved = interleave(audBuf);
    const bytesPerSample = 2;
    const blockAlign = numCh * bytesPerSample;
    const buffer = new ArrayBuffer(44 + interleaved.length*2);
    const view = new DataView(buffer);

    function writeString(off, str){ for(let i=0;i<str.length;i++) view.setUint8(off+i, str.charCodeAt(i)); }
    function write16(off, val){ view.setUint16(off, val, true); }
    function write32(off, val){ view.setUint32(off, val, true); }

    writeString(0, 'RIFF');
    write32(4, 36 + interleaved.length*2);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    write32(16, 16);
    write16(20, 1);
    write16(22, numCh);
    write32(24, sr);
    write32(28, sr * blockAlign);
    write16(32, blockAlign);
    write16(34, 16);
    writeString(36, 'data');
    write32(40, interleaved.length*2);

    let offset = 44;
    for(let i=0;i<interleaved.length;i++){
      const s = Math.max(-1, Math.min(1, interleaved[i]));
      view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
      offset += 2;
    }
    return new Blob([view], {type:'audio/wav'});
  }

  function interleave(buf){
    const ch = [];
    for(let i=0;i<buf.numberOfChannels;i++) ch.push(buf.getChannelData(i));
    const len = buf.length;
    const inter = new Float32Array(len * buf.numberOfChannels);
    let idx = 0;
    for(let i=0;i<len;i++){
      for(let c=0;c<ch.length;c++){
        inter[idx++] = ch[c][i];
      }
    }
    return inter;
  }

  downloadBtn.onclick = async ()=>{
    if(!buf) return;
    setStatus('Rendering (smooth)…');
    downloadBtn.disabled = true;
    try{
      const rendered = await renderProcessed(buf, parseFloat(speed.value), parseInt(reverb.value), parseFloat(bass.value));
      const wav = toWav(rendered);
      const a = document.createElement('a');
      const name = (fileMeta?.name||'audio').replace(/\.[^.]+$/,'');
      a.href = URL.createObjectURL(wav);
      a.download = `${name}_ngp-remix.wav`;
      a.click();
      setStatus('Done.');
    }catch(e){
      console.error(e); setStatus('Render failed');
    }finally{
      downloadBtn.disabled = false;
    }
  };

  // Resize canvas on layout change
  new ResizeObserver(()=>{
    cvs.width = wave.clientWidth; cvs.height = wave.clientHeight; drawWave(buf);
  }).observe(wave);
</script>
</body>
</html>
